<!DOCTYPE html><html lang="en"> <head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v4.11.3"><title>Rust NTP Client</title><link rel="stylesheet" href="/_astro/about.ziih_YEc.css">
<style>html{background-color:#2e3440;font-family:sans-serif;margin:20px}header{background-color:#434c5e;border-radius:25px;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}footer{background-color:#434c5e;border-radius:25px}footer a:hover,footer a:focus{background-color:#81a1c1;border-radius:25px}body{margin:0 auto;width:100%;max-width:80ch;padding:1rem;line-height:1.5;color:#d8dee9;background-color:#4c566a;border-radius:25px}.body-content{padding:20px}.body-content ul{margin-left:30px}*{box-sizing:border-box}h1{margin:1rem 0;font-size:2.5rem;color:#d8dee9}ul{list-style:circle}.blog-links a{color:#ebcb8b}.blog-links li{list-style:circle}.hamburger{padding:10px 20px;cursor:pointer}.hamburger .line{display:block;width:30px;height:5px;margin-top:10px;margin-bottom:10px;background-color:#eceff4}.nav-links{width:100%;top:5rem;left:48px;background-color:#a09c96;display:none;margin:0;color:#d8dee9}.nav-links a{display:block;text-align:center;padding:10px 0;text-decoration:none;font-size:1.2rem;font-weight:700;text-transform:uppercase;background-color:#5e81ac;border-radius:25px}.nav-links a:hover,.nav-links a:focus{background-color:#81a1c1;border-radius:25px}.expanded{display:unset}@media screen and (min-width: 636px){.nav-links{margin-left:5em;display:block;position:static;width:auto;background:none}.nav-links a{display:inline-block;padding:15px 20px}.hamburger{display:none}}a[data-astro-cid-yxtifmrq]{padding:.5rem 1rem;color:#fff;background-color:#5e81ac;text-decoration:none;border-radius:25px}footer[data-astro-cid-sz7xmlte]{display:flex;gap:1rem;margin-top:2rem}
</style><script type="module">document.querySelector(".hamburger").addEventListener("click",()=>{document.querySelector(".nav-links").classList.toggle("expanded")});
</script></head> <body> <header> <nav> <div class="hamburger"> <span class="line"></span> <span class="line"></span> <span class="line"></span> </div> <div class="nav-links"> <a href="/">Home</a> <a href="/about/">About</a> <a href="/blog/">Blog</a> </div> </nav> </header> <h1>Rust NTP Client</h1> <div class="body-content">  <p>Written by Todd</p> <p>Published on: 2022-11-09</p> <h1 id="introduction">Introduction</h1>
<p>Something that I thought would be interesting is to dabble a little bit with some obscure network programming, however something simple. This is the Network Time Protocol(NTP). NTP has been around for year, before 1985 and is a way to synchronize time across computers in networks. There have been 4 version of this protocol with the latest indepth RFC being 5905 and RFC 7822 with some updates. RFC 5905 established the standard for NTPv4. There is also a more light weight subset of NTP called SNTP, however, here I will focus on implementing a simple client using NTPv4.</p>
<h1 id="datastructure">Datastructure</h1>
<p>The primary packet for NTPv4 has one form. It consists of 48 bytes of data. Or atleat, those are the parts of the packet we care about. There are some option fields, however, we will not concern ourselves with this. The information for What we care about as far as the packet in RFC 5905 is located in page 17, chapter 7.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> Field</span><span style="color:#F97583">               |</span><span style="color:#B392F0"> Size</span><span style="color:#F97583">    |</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0">:--------------------</span><span style="color:#F97583">|</span><span style="color:#B392F0">:--------</span><span style="color:#F97583">|</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> LI</span><span style="color:#F97583">                  |</span><span style="color:#B392F0"> 2</span><span style="color:#9ECBFF"> bits</span><span style="color:#F97583">  |</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> VN</span><span style="color:#F97583">                  |</span><span style="color:#B392F0"> 3</span><span style="color:#9ECBFF"> bits</span><span style="color:#F97583">  |</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> Mode</span><span style="color:#F97583">                |</span><span style="color:#B392F0"> 3</span><span style="color:#9ECBFF"> bits</span><span style="color:#F97583">  |</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> Stratum</span><span style="color:#F97583">             |</span><span style="color:#B392F0"> 1</span><span style="color:#9ECBFF"> byte</span><span style="color:#F97583">  |</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> Poll</span><span style="color:#F97583">                |</span><span style="color:#B392F0"> 1</span><span style="color:#9ECBFF"> byte</span><span style="color:#F97583">  |</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> Precision</span><span style="color:#F97583">           |</span><span style="color:#B392F0"> 1</span><span style="color:#9ECBFF"> byte</span><span style="color:#F97583">  |</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> Root</span><span style="color:#9ECBFF"> delay</span><span style="color:#F97583">          |</span><span style="color:#B392F0"> 4</span><span style="color:#9ECBFF"> bytes</span><span style="color:#F97583"> |</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> Root</span><span style="color:#9ECBFF"> Dispersion</span><span style="color:#F97583">     |</span><span style="color:#B392F0"> 4</span><span style="color:#9ECBFF"> bytes</span><span style="color:#F97583"> |</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> Reference</span><span style="color:#9ECBFF"> ID</span><span style="color:#F97583">        |</span><span style="color:#B392F0"> 4</span><span style="color:#9ECBFF"> bytes</span><span style="color:#F97583"> |</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> Reference</span><span style="color:#9ECBFF"> Timestamp</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> 4</span><span style="color:#9ECBFF"> bytes</span><span style="color:#F97583"> |</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> Origin</span><span style="color:#9ECBFF"> Timestamp</span><span style="color:#F97583">    |</span><span style="color:#B392F0"> 4</span><span style="color:#9ECBFF"> bytes</span><span style="color:#F97583"> |</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> Receive</span><span style="color:#9ECBFF"> Timestamp</span><span style="color:#F97583">   |</span><span style="color:#B392F0"> 4</span><span style="color:#9ECBFF"> bytes</span><span style="color:#F97583"> |</span></span>
<span class="line"><span style="color:#F97583">    |</span><span style="color:#B392F0"> Transmit</span><span style="color:#9ECBFF"> Timespace</span><span style="color:#F97583">  |</span><span style="color:#B392F0"> 4</span><span style="color:#9ECBFF"> bytes</span><span style="color:#F97583"> |</span></span>
<span class="line"></span></code></pre>
<p>First is LI, which is short for <em>Leap Indicator</em>. This will indicate if there anything we need to concern ourselves about a leap second being added or subtracted. This takes up the first 2 bits. Next is VN, <em>Version Number</em>, encoded in 3 bits. After that is the <em>Mode</em> for 3 bits. When handling this packet, the first 3 fields will fit in an unsigned 8-bit integer, in rust as a u8.</p>
<p>In the rest of the packet, 1 byte can be treated as a <em>u8</em> in Rust and 4 bytes as a <em>u32</em>.</p>
<p><em>Stratum</em> is an interesting concept in NTP. The <em>Stratum Model</em> has to deal with the hierarchy of machines. Levels 0-15 indicate the deviceâ€™s distance from the reference clock. Stratum 0 can be directly connected to something such as an atomix clock. Stratum 0 devices are usually connected directly to a Startum 1 device that will serve as the time server to distribute time to Stratum 2 clients or servers and so on. Generally, it can be assumed that the higher the stratum number is, the less stability and accuracy there is. Any stratum greater than 15 is rejected.</p>
<p><em>Poll</em> is the max interval between messages, this is taken in log2 seconds.</p>
<p><em>Precision</em> represents the precision of the system clock, also in log2 seconds.</p>
<p>For the remaining fields, I suggest taking a look at <em>RFC 5905</em>.</p>
<h1 id="mainrs">main.rs</h1>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">  use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">net</span><span style="color:#F97583">::</span><span style="color:#B392F0">UdpSocket</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  use</span><span style="color:#B392F0"> rs_sntp</span><span style="color:#F97583">::</span><span style="color:#B392F0">ntp_client</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{write_data_packet, read_data_packet, </span><span style="color:#B392F0">NtpDataPacket</span><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> HOST</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "0.pool.ntp.org"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> PORT</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">str</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "123"</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  fn</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> packet </span><span style="color:#F97583">=</span><span style="color:#B392F0"> NtpDataPacket</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> connection_string </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> HOST</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_owned</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">+</span><span style="color:#9ECBFF"> ":"</span><span style="color:#F97583"> +</span><span style="color:#79B8FF"> PORT</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> socket</span><span style="color:#F97583">:</span><span style="color:#B392F0"> UdpSocket</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> UdpSocket</span><span style="color:#F97583">::</span><span style="color:#B392F0">bind</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"0.0.0.0:8000"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        .</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Could not bind to socket"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    socket</span><span style="color:#F97583">.</span><span style="color:#B392F0">connect</span><span style="color:#E1E4E8">(connection_string)</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Could not connect to server"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    write_data_packet</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">socket);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Data sent"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> response </span><span style="color:#F97583">=</span><span style="color:#B392F0"> read_data_packet</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">socket);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Data reseived"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    packet</span><span style="color:#F97583">.</span><span style="color:#B392F0">parse_response</span><span style="color:#E1E4E8">(response);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"{:?}"</span><span style="color:#E1E4E8">, packet);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span></code></pre>
<p>Here is the main source file of the program. In the program we create an NtpDataPacket which is a structure I made to represent the packet for NTP. I also have some constants set for the host and port of one of the many publically availiable NTP servers. NTP uses UDP, so a UDPSocket is created, binded and connected. Next, write to the socket, which will be covered later in this article. Read the response, parse and display. Pretty straight forward and simple. THe magic for the protocol happens in the <code>ntp_client.rs</code> file.</p>
<h1 id="librs">lib.rs</h1>
<p>Really simple <code>lib.rs</code> file</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">       pub</span><span style="color:#F97583"> mod</span><span style="color:#B392F0"> ntp_client</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span></code></pre>
<h1 id="ntp_clientrs">ntp_client.rs</h1>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#F97583">  use</span><span style="color:#B392F0"> std</span><span style="color:#F97583">::</span><span style="color:#B392F0">net</span><span style="color:#F97583">::</span><span style="color:#B392F0">UdpSocket</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">  #[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">  pub</span><span style="color:#F97583"> struct</span><span style="color:#B392F0"> NtpDataPacket</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    li_vn_mode</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    strat</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">, </span></span>
<span class="line"><span style="color:#E1E4E8">    poll</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    prec</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u8</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    root_delay</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    root_dispersion</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    ref_id</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    ref_time_seconds</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    ref_time_fraction</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    origin_ts_seconds</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    origin_ts_fraction</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    recv_ts_seconds</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    recv_ts_fraction</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    tx_ts_seconds</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    tx_ts_fraction</span><span style="color:#F97583">:</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> write_data_packet</span><span style="color:#E1E4E8">(socket</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">UdpSocket</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> buf </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">48</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#E1E4E8">    buf[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0x1b</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    socket</span><span style="color:#F97583">.</span><span style="color:#B392F0">send</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">buf)</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Issue with sending to server"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> read_data_packet</span><span style="color:#E1E4E8">(socket</span><span style="color:#F97583">:</span><span style="color:#F97583"> &#x26;</span><span style="color:#B392F0">UdpSocket</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">48</span><span style="color:#E1E4E8">] {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#F97583"> mut</span><span style="color:#E1E4E8"> buf</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">48</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">48</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> let</span><span style="color:#B392F0"> Ok</span><span style="color:#E1E4E8">(r) </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> socket</span><span style="color:#F97583">.</span><span style="color:#B392F0">recv</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#E1E4E8"> buf) { </span></span>
<span class="line"><span style="color:#B392F0">        println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Received: {} bytes"</span><span style="color:#E1E4E8">, r);</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> { </span></span>
<span class="line"><span style="color:#B392F0">        println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error receiving from server!"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> buf;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  impl</span><span style="color:#B392F0"> NtpDataPacket</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> new</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-></span><span style="color:#79B8FF"> Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#79B8FF">        Self</span><span style="color:#E1E4E8"> { li_vn_mode</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, strat</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, poll</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, prec</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, root_delay</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, root_dispersion</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, ref_id</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, ref_time_seconds</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, ref_time_fraction</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, origin_ts_seconds</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, origin_ts_fraction</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, recv_ts_seconds</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, recv_ts_fraction</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, tx_ts_seconds</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, tx_ts_fraction</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    pub</span><span style="color:#F97583"> fn</span><span style="color:#B392F0"> parse_response</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;mut</span><span style="color:#79B8FF"> self</span><span style="color:#E1E4E8">, resp</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">48</span><span style="color:#E1E4E8">]) {</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">li_vn_mode </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">strat </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">poll </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">prec </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">root_delay </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 24</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">root_delay </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">root_delay </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">root_delay </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">7</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">root_dispersion </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">8</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 24</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">root_dispersion </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">9</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">root_dispersion </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">root_dispersion </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">11</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">ref_id </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">12</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 24</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">ref_id </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">13</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">ref_id </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">14</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">ref_id </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">15</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">ref_time_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">16</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 24</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">ref_time_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">17</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">ref_time_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">18</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">ref_time_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">19</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">ref_time_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">20</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 24</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">ref_time_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">21</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">ref_time_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">22</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">ref_time_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">23</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">origin_ts_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">24</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 24</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">origin_ts_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">25</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">origin_ts_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">26</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">origin_ts_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">27</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">origin_ts_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">28</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 24</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">origin_ts_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">29</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">origin_ts_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">30</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">origin_ts_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">31</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">recv_ts_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">32</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 24</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">recv_ts_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">33</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">recv_ts_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">34</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">recv_ts_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">35</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">recv_ts_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">36</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 24</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">recv_ts_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">37</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">recv_ts_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">38</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">recv_ts_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">39</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">tx_ts_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">40</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 24</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">tx_ts_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">41</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">tx_ts_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">42</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">tx_ts_seconds </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">43</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">tx_ts_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">44</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 24</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">tx_ts_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">45</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">tx_ts_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> (resp[</span><span style="color:#79B8FF">46</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&#x3C;&#x3C;</span><span style="color:#79B8FF"> 8</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#79B8FF">        self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">tx_ts_fraction </span><span style="color:#F97583">|=</span><span style="color:#E1E4E8"> resp[</span><span style="color:#79B8FF">47</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">as</span><span style="color:#B392F0"> u32</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span></code></pre>
<h2 id="ntpdatapacket">NtpDataPacket</h2>
<p>This is a structure that defines the packet for the protocol. Some of the fields are described some above. This structure is 48 bytes in total. To keep communication simple, an array of 48 bytes (u8) is created, sent and we received it. A function is created in the implementation block of NtpDataPacket to parse the 48 byte block received into the data structure for better handling. Using bitwise logical operators to ensure that data is placed appropraitely.</p>
<h2 id="what-is-required-by-the-packet">What is required by the packet</h2>
<p>In the send function, before sending the 48 byte packet, the first byte is set to value <code>0x1b</code>. This is <code>0b00011011</code>. This will set the appropriate LI, VN and Mode bits.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#F97583">   |</span><span style="color:#B392F0"> Key</span><span style="color:#F97583">  |</span><span style="color:#B392F0"> Value</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> Meaning</span><span style="color:#F97583">                                                                     |</span></span>
<span class="line"><span style="color:#F97583">   |</span><span style="color:#B392F0">:-----</span><span style="color:#F97583">|</span><span style="color:#B392F0">:------</span><span style="color:#F97583">|</span><span style="color:#B392F0">-----------------------------------------------------------------------------</span><span style="color:#F97583">|</span></span>
<span class="line"><span style="color:#F97583">   |</span><span style="color:#B392F0"> LI</span><span style="color:#F97583">   |</span><span style="color:#B392F0"> 00</span><span style="color:#F97583">    |</span><span style="color:#B392F0"> This</span><span style="color:#9ECBFF"> is</span><span style="color:#9ECBFF"> for</span><span style="color:#9ECBFF"> server</span><span style="color:#9ECBFF"> use,</span><span style="color:#9ECBFF"> server</span><span style="color:#9ECBFF"> decide</span><span style="color:#9ECBFF"> is</span><span style="color:#9ECBFF"> leap</span><span style="color:#9ECBFF"> second</span><span style="color:#9ECBFF"> is</span><span style="color:#9ECBFF"> inserted</span><span style="color:#9ECBFF"> or</span><span style="color:#9ECBFF"> deleted</span><span style="color:#F97583"> |</span></span>
<span class="line"><span style="color:#F97583">   |</span><span style="color:#B392F0"> VN</span><span style="color:#F97583">   |</span><span style="color:#B392F0"> 011</span><span style="color:#F97583">   |</span><span style="color:#B392F0"> Version</span><span style="color:#9ECBFF"> number,</span><span style="color:#9ECBFF"> set</span><span style="color:#9ECBFF"> to</span><span style="color:#79B8FF"> 3</span><span style="color:#9ECBFF"> in</span><span style="color:#9ECBFF"> this</span><span style="color:#9ECBFF"> example,</span><span style="color:#9ECBFF"> could</span><span style="color:#9ECBFF"> also</span><span style="color:#9ECBFF"> be</span><span style="color:#9ECBFF"> set</span><span style="color:#9ECBFF"> to</span><span style="color:#79B8FF"> 4</span><span style="color:#F97583">            |</span></span>
<span class="line"><span style="color:#F97583">   |</span><span style="color:#B392F0"> Mode</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> 011</span><span style="color:#F97583">   |</span><span style="color:#B392F0"> Mode</span><span style="color:#9ECBFF"> is</span><span style="color:#9ECBFF"> set</span><span style="color:#9ECBFF"> to</span><span style="color:#9ECBFF"> 3,</span><span style="color:#9ECBFF"> which</span><span style="color:#9ECBFF"> means</span><span style="color:#9ECBFF"> client</span><span style="color:#9ECBFF"> mode</span><span style="color:#F97583">                                   |</span></span>
<span class="line"></span></code></pre>
<p>The version and mode need to be set in order to get a response.</p>
<h1 id="output">Output</h1>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>NtpDataPacket { li_vn_mode: 28, strat: 2, poll: 3, prec: 236, root_delay: 3802, root_dispersion: 1545, ref_id: 2886875149, ref_time_seconds: 3877304791, ref_time_fraction: 1240575520, origin_ts_seconds: 0, origin_ts_fraction: 0, recv_ts_seconds: 3877306283, recv_ts_fraction: 2288430625, tx_ts_seconds: 3877306283, tx_ts_fraction: 2288611839 }</span></span>
<span class="line"><span></span></span></code></pre>
<p>Above is the output from the server. The primary field toget the time is the <code>tx_ts_seconds</code> field. However, converting that will not give the current time. <code>3877306283</code> yields a date and time of <code>November 12th, 2092 5:31:23 AM.</code> So, how do we get the correct time? We substract 70 years worth of seconds from the time. This is 1900 to the UNIX epoch of Janruary 1st, 1970. 70 years in seconds is <code>2208988800</code>. This will give us the proper time.</p>  </div> <footer data-astro-cid-sz7xmlte> <a href="https://www.github.com/martintc" data-astro-cid-yxtifmrq>github</a>  </footer>  </body> </html>